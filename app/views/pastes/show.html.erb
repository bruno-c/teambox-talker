<% @title = "Paste #" + @paste.id %>

<% content_for :head do %>
  <style>
    html { overflow: hidden } /* for Win IE 6 */
    body { margin:0; padding:0; border:0; overflow: hidden; }
    #editorcontainer { height: 1000px; /* changed programmatically */ }
    #editorcontainer iframe { width: 100%; height: 100%; border:0; padding:0; margin:0; }
  </style>
  <script type="text/javascript" charset="utf-8">
    Talker.currentUser = <%= current_user.to_json %>;
    Talker.paste = <%= @paste.to_json %>;
    
    Orbited.settings.hostname = '<%= request.host %>';
    Orbited.settings.port = <%= Orbited.port %>;
    Orbited.settings.protocol = '<%= request.ssl? ? "https" : "http" %>'
    Orbited.settings.streaming = true;
    TCPSocket = Orbited.TCPSocket;
    
    $(function() {
      document.domain = document.domain;
      
      window.editor = new Ace2Editor();
      var text = "<%= escape_javascript @paste.content %>"; // initial text
      
      editor.resize = function() {
        $("#editorcontainer").get(0).style.height = "100%";
        editor.getFrame().style.height = ((document.documentElement.clientHeight)-1)+"px";
        editor.adjustSize();
      };
      
      editor.init("editorcontainer", text, function() {
        editor.setAuthorInfo("1", {bgcolor: "#ccf"});
        editor.setAuthorInfo("2", {bgcolor: "#fcc"});
        var attribs = createAttributions("<%= escape_javascript @paste.attributions %>");
        editor.setBaseAttributedText({text: text + "\n", attribs: attribs.changeset },
                                     { numToAttrib: attribs.pool });
        editor.setEditable(true); 
        editor.setProperty("showsauthorcolors", true);
        editor.setProperty("userauthor", Talker.currentUser.id.toString());
        editor.setProperty("wraps", true);
        
        editor.setUserChangeNotificationCallback(function() {
          // Compute local diff
          var cs = editor.prepareUserChangeset();
          console.info(cs.changeset);
          var diff = rewriteAttributions(cs.changeset, 0, Talker.currentUser.id);
          // Send to server
          Talker.client.queueSend({type: 'message', user: Talker.currentUser, content: diff}, function() {
            // Reset local copy when sent
            editor.applyPreparedChangesetToBase();
          });
        });
        editor.resize();
        $(window).bind("resize", editor.resize);
        setTimeout(function() {editor.focus();}, 0);
      });
      
      var receiver = {};
      receiver.onMessageReceived = function(event) {
        // Do not apply local diff
        if (event.user.id == Talker.currentUser.id) return false;
        
        var attribs = createAttributions(event.content);
        editor.applyChangesToBase(attribs.changeset, event.user.id.toString(),
                                  { numToAttrib: attribs.pool });
      };
      
      // Rewrite an attribution in a changeset
      var rewriteAttributions = function(cs, attrib, userId, first) {
        var re = new RegExp("\\*" + attrib, first ? "" : "g");
        return cs.replace(re, "*" + userId);
      }
      // Create an attribution pool from a changeset, extracting user ids from
      // the changeset and replacing w/ indexes in the attribution pool.
      window.createAttributions = function(cs) {
        var pool = [];
        var authors = {};
        var matches = null;
        var re = /\*(\d+)[^\d]/g;
        while (matches = re.exec(cs)) {
          var id = matches[1];
          var num = authors[id];
          if (num == null) {
            authors[id] = num = pool.length;
            pool.push(["author", id]);
          }
          cs = rewriteAttributions(cs, id, num, true);
        }
        return { changeset: cs, pool: pool };
      }
      
      // Talker.plugins.push(new Talker.ErrorHandler($("#error")));
      Talker.plugins.push(new Talker.Users());
      Talker.plugins.push(receiver);
      
      Talker.client = new Talker.Client({
        host: '<%= Orbited.talker_host %>', 
        port: <%= Orbited.talker_port %>, 
        paste: Talker.paste.id,
        token: <%= current_user.talker_token.to_json %>,
        callbacks: Talker.Broadcaster
      }).connect();
      
      Talker.trigger("Loaded");
      
      $(window).bind('beforeunload', function() { Talker.client.reset() });
    });
  </script>
<% end %>

<div id="editorcontainer"><!-- --></div>
