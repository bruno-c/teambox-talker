<% @title = "Paste ##{@paste.id}" %>

<% content_for :head do %>
  <style>
    html { overflow: hidden } /* for Win IE 6 */
    body { margin:0; padding:0; border:0; overflow: hidden; }
    #editorcontainer { height: 1000px; /* changed programmatically */ }
    #editorcontainer iframe { width: 100%; height: 100%; border:0; padding:0; margin:0; }
  </style>
  <script type="text/javascript" charset="utf-8">
    Talker.currentUser = <%= current_user.to_json %>;
    Talker.paste = <%= @paste.to_json %>;
    
    Orbited.settings.hostname = '<%= request.host %>';
    Orbited.settings.port = <%= Orbited.port %>;
    Orbited.settings.protocol = '<%= request.ssl? ? "https" : "http" %>'
    Orbited.settings.streaming = true;
    TCPSocket = Orbited.TCPSocket;
    
    $(function() {
      document.domain = document.domain;
      
      var editor = new Ace2Editor();
      var text = "<%= escape_javascript @paste.content %>"; // initial text
      
      editor.resize = function() {
        $("#editorcontainer").get(0).style.height = "100%";
        editor.getFrame().style.height = ((document.documentElement.clientHeight)-1)+"px";
        editor.adjustSize();
      };
      
      editor.init("editorcontainer", text, function() {
        <% current_account.users.each do |user| -%>
        editor.setAuthorInfo("<%= user.id %>", {bgcolor: "<%= user.color %>"});
        <%- end -%>
        <% if @paste.attributions.present? %>
        var attribs = Talker.Paste.createAttributions("<%= escape_javascript @paste.attributions %>");
        editor.setBaseAttributedText({text: text + "\n", attribs: attribs.changeset },
                                     { numToAttrib: attribs.pool });
        <% else %>
        editor.setBaseText(text + "\n");
        <% end %>
        
        editor.setEditable(true); 
        editor.setProperty("showsauthorcolors", true);
        editor.setProperty("userauthor", Talker.currentUser.id.toString());
        editor.setProperty("wraps", true);
        
        editor.setUserChangeNotificationCallback(function() {
          // Compute local diff
          var cs = editor.prepareUserChangeset();
          var diff = Talker.Paste.rewriteAttributions(cs.changeset, 0, Talker.currentUser.id);
          // Send to server
          Talker.client.queueSend({type: 'message', user: Talker.currentUser, content: diff}, function() {
            // Reset local copy when sent
            editor.applyPreparedChangesetToBase();
          });
        });
        editor.resize();
        $(window).bind("resize", editor.resize);
        setTimeout(function() {editor.focus();}, 0);
      });
      
      // Talker.plugins.push(new Talker.ErrorHandler($("#error")));
      Talker.plugins.push(new Talker.Users());
      Talker.plugins.push(new Talker.Paste.Updater(editor));
      
      Talker.client = new Talker.Client({
        host: '<%= Orbited.talker_host %>', 
        port: <%= Orbited.talker_port %>, 
        paste: Talker.paste.id,
        token: <%= current_user.talker_token.to_json %>,
        callbacks: Talker.Broadcaster
      }).connect();
      
      Talker.trigger("Loaded");
      
      $(window).bind('beforeunload', function() { Talker.client.reset() });
    });
  </script>
<% end %>

<div id="editorcontainer"><!-- --></div>
