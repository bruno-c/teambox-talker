#!/usr/bin/env ruby

$:.unshift File.dirname(__FILE__) + "/../lib"
require "rubygems"
require "talker"
require "eventmachine"
require "amqp"

room, user, token = ARGV[0..2]

module KeyboardInput
  include EM::Protocols::LineText2
  
  attr_accessor :client
  
  def receive_line(data)
    case data
    when "/close"
      @client.close
    else
      @client.send_message(data)
    end
  end
end

EM.run do
  AMQP.connect :host => 'localhost'
  
  Talker::Client.connect("0.0.0.0", 61800, room, user, token) do |client|
    client.on_message do |message|
      case message["type"]
      when "join", "leave"
        puts message["user"] + " " + message["type"] + "s"
      when "message"
        puts message["from"] + ": " + message["content"]
      end
    end
    
    client.on_closed do
      puts "disconnected"
      EM.stop
      exit
    end
    
    EM.open_keyboard(KeyboardInput) { |i| i.client = client }
    trap("INT") { EM.stop }
  end

end