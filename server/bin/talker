#!/usr/bin/env ruby
$:.unshift File.dirname(__FILE__) + "/../lib"
require "rubygems"
require "talker"

abort "usage: talker [config_file.yml]" unless ARGV.first

config = Talker::Config.new(ARGV.first)

EM.run do
  puts "Connected to AMQP on #{config[:amqp][:host]}:#{config[:amqp][:port]}"
  AMQP.connect config[:amqp]
  
  server = Talker::Server.new(config[:talker])
  if config[:talker][:no_auth]
    puts "!! WARNING starting server with authentication disabled !!"
    server.authenticator = Talker::NullAuthenticator.new
  else
    server.authenticator = Talker::MysqlAuthenticator.new(config[:database])
  end
  
  trap('INT') do
    puts "Stopping ..."
    server.stop
    # FIXME hang
    #AMQP.stop { EM.stop }
    EM.stop
  end
  
  $0 = "talker:#{server.port}"
  puts "Listening on #{server.host}:#{server.port}"
  server.start
end