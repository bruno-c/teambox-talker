#!/usr/bin/env ruby
$:.unshift File.dirname(__FILE__) + "/../lib"
require "optparse"
require "rubygems"
require "talker"

amqp_host = "localhost"
amqp_port = 5672
db = {
  :database => "talker_development",
  :username => "root",
  :password => "",
  :host => "localhost"
}

OptionParser.new do |opts|
  opts.banner = "Usage: #{$PROGRAM_NAME} [options]"

  opts.separator "AMQP"
  opts.on("--amqp-host HOST", "AMQP Server host")         { |x| amqp_host = x }
  opts.on("--amqp-port NUM", "AMQP Server port")          { |x| amqp_port = x.to_i }
  
  opts.separator "Logging"
  opts.on("--database NAME", "Database name")             { |x| db[:database] = x }
  opts.on("--username NAME", "Database username")         { |x| db[:user] = x }
  opts.on("--password VALUE", "Database password")        { |x| db[:password] = x }
  opts.on("--host NAME", "Database host")                 { |x| db[:host] = x }
  
  opts.separator ""
  opts.on_tail("-h", "--help", "Show this message")       { puts opts; exit }
end.parse!(ARGV)


trap('INT') do
  AMQP.stop { EM.stop }
end

EM.run do
  puts "Connected to AMQP on #{amqp_host}:#{amqp_port}"
  AMQP.connect :host => amqp_host, :port => amqp_port
  puts "Logging to #{db[:database]}@#{db[:host]}"
  $0 = "talker-logger"
  Talker::Logger.start db
end